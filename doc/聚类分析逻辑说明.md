# 用水行为聚类分析 - 逻辑详细说明

## 一、整体架构

```
用水记录(water_usage_record)
        ↓
    特征提取/聚合
        ↓
用水特征(water_usage_feature)
        ↓
   ┌────┴────┐
   ↓         ↓
K-Means   异常检测
聚类分析   规则匹配
   ↓         ↓
更新聚类标签  异常记录(water_anomaly_record)
```

---

## 二、数据流程

### 2.1 数据来源

**用水记录表 (water_usage_record)**：普通用户录入的每日用水明细

| 字段 | 说明 |
|------|------|
| usage_date | 用水日期 |
| usage_amount | 用水量(m³) |
| usage_type | 用水类型(饮用/烹饪/洗浴等) |
| time_period | 时段(凌晨/上午/下午/晚间) |
| is_weekend | 是否周末 |

### 2.2 特征提取

系统按**用户+月份**聚合原始记录，生成用水特征：

**用水特征表 (water_usage_feature)**

| 特征字段 | 计算方式 | K-Means用途 |
|----------|----------|-------------|
| total_usage | SUM(用水量) | 判断总消耗 |
| avg_daily_usage | 总用水量/天数 | 判断日常消耗水平 |
| usage_count | COUNT(记录数) | 判断用水频率 |
| dawn_ratio | 凌晨用水量/总量×100% | 时段偏好分析 |
| morning_ratio | 上午用水量/总量×100% | 时段偏好分析 |
| afternoon_ratio | 下午用水量/总量×100% | 时段偏好分析 |
| evening_ratio | 晚间用水量/总量×100% | 时段偏好分析 |
| weekend_ratio | 周末用水量/总量×100% | 工作日/周末偏好 |

---

## 三、K-Means聚类算法

### 3.1 算法原理

K-Means是一种**无监督学习**算法，将数据点划分为K个簇，使得每个簇内的数据点尽可能相似。

**核心步骤**：
1. **初始化**：随机选择K个数据点作为初始质心（本系统使用K-Means++优化）
2. **分配**：将每个数据点分配到最近的质心所在的簇
3. **更新**：重新计算每个簇的质心（取簇内所有点的均值）
4. **迭代**：重复步骤2-3，直到质心不再变化或达到最大迭代次数

### 3.2 算法配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| k | 3 | 聚类数量，对应"节约型、正常型、高耗型" |
| maxIterations | 100 | 最大迭代次数 |
| convergenceThreshold | 0.0001 | 收敛阈值，质心变化小于此值时停止 |
| normalize | true | 是否启用Z-score标准化 |

### 3.3 数据标准化

由于不同特征的量纲不同（如用水量是小数，占比是百分比），需要进行**Z-score标准化**：

```
标准化值 = (原始值 - 均值) / 标准差
```

标准化后，所有特征的均值为0，标准差为1，消除量纲影响。

### 3.4 距离计算

使用**欧几里得距离**计算数据点之间的相似度：

```
距离 = √[(x1-y1)² + (x2-y2)² + ... + (xn-yn)²]
```

### 3.5 聚类评估指标

| 指标 | 说明 | 最优方向 |
|------|------|----------|
| SSE | 误差平方和，簇内数据点到质心的距离之和 | 越小越好 |
| 轮廓系数 | 衡量聚类紧密度和分离度，范围[-1,1] | 越接近1越好 |

### 3.6 聚类标签分配

聚类完成后，根据每个簇的**日均用水量均值**自动分配标签：

- 日均用水量最低的簇 → **节约型**
- 日均用水量中等的簇 → **正常型**
- 日均用水量最高的簇 → **高耗型**

---

## 四、异常检测规则

### 4.1 规则化检测原理

基于业务规则，对用水特征进行阈值判断，识别异常用水行为。

### 4.2 内置异常规则

#### 规则1：凌晨用水异常 (DAWN_USAGE_ABNORMAL)

| 项目 | 内容 |
|------|------|
| 触发条件 | 凌晨用水占比 > 15% |
| 异常原因 | 正常家庭凌晨(0-6点)用水极少，高占比可能表示漏水或异常使用 |
| 阈值参数 | threshold = 15 (可配置) |

#### 规则2：日均用水异常 (HIGH_DAILY_USAGE)

| 项目 | 内容 |
|------|------|
| 触发条件 | 日均用水量 > 0.5 m³ |
| 异常原因 | 普通家庭日均用水约0.2-0.3m³，超过0.5m³可能存在浪费或漏水 |
| 阈值参数 | threshold = 0.5 (可配置) |

#### 规则3：周末用水异常 (WEEKEND_USAGE_ABNORMAL)

| 项目 | 内容 |
|------|------|
| 触发条件 | 周末用水占比 > 40% |
| 异常原因 | 周末仅占一周的2/7≈28.6%，占比过高可能表示工作日无人在家或周末集中用水 |
| 阈值参数 | threshold = 40 (可配置) |

### 4.3 异常记录存储

检测到的异常存入 `water_anomaly_record` 表：

| 字段 | 说明 |
|------|------|
| anomaly_type | 异常类型编码 |
| anomaly_desc | 异常描述 |
| anomaly_value | 实际检测值 |
| threshold_value | 触发阈值 |
| status | 处理状态(0-待处理,1-已处理,2-已忽略) |

---

## 五、代码结构

### 5.1 算法代码 (ruoyi-common/kmeans)

```
kmeans/
├── KMeansAlgorithm.java    # K-Means算法核心实现
├── KMeansConfig.java       # 算法配置类
├── DataPoint.java          # 数据点类
├── ClusterResult.java      # 聚类结果类
├── AnomalyDetector.java    # 异常检测器
└── AnomalyRule.java        # 异常规则定义
```

### 5.2 业务代码 (ruoyi-water)

```
water/
├── domain/
│   ├── WaterUsageFeature.java     # 用水特征实体
│   └── WaterAnomalyRecord.java    # 异常记录实体
├── mapper/
│   ├── WaterUsageFeatureMapper.java
│   └── WaterAnomalyRecordMapper.java
└── service/
    ├── WaterClusterService.java        # 服务接口
    └── impl/WaterClusterServiceImpl.java  # 服务实现
```

### 5.3 控制器 (ruoyi-admin)

```
controller/water/
└── WaterClusterController.java    # 聚类分析API
```

---

## 六、API接口说明

| 接口 | 方法 | 说明 |
|------|------|------|
| /water/cluster/generateFeature | GET | 生成特征数据 |
| /water/cluster/execute | GET | 执行K-means聚类 |
| /water/cluster/config | GET/POST | 获取/更新算法配置 |
| /water/cluster/result | GET | 查询聚类结果(分页) |
| /water/cluster/statistics | GET | 查询聚类统计 |
| /water/cluster/detectAnomaly | GET | 执行异常检测 |
| /water/cluster/rules | GET/POST | 获取/更新异常规则 |
| /water/cluster/anomaly/list | GET | 查询异常记录(分页) |
| /water/cluster/anomaly/handle | GET | 处理异常记录 |
| /water/cluster/analyzeAll | GET | 一键分析(特征+聚类+异常) |

---

## 七、执行流程示例

```
1. 业务员选择统计周期：2024-12
   
2. 点击"一键分析"按钮
   │
   ├─→ 步骤1：生成特征数据
   │   └─ 聚合该月所有用水记录，计算每个用户的特征
   │
   ├─→ 步骤2：执行K-Means聚类
   │   ├─ 数据标准化
   │   ├─ K-Means++初始化质心
   │   ├─ 迭代更新质心和分配
   │   └─ 更新用户的cluster_id和cluster_label
   │
   └─→ 步骤3：执行异常检测
       ├─ 遍历所有用户特征
       ├─ 匹配异常规则
       └─ 记录异常到water_anomaly_record表

3. 页面展示聚类结果和异常记录
```

